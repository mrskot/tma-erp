<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë∑ –ö–∞–±–∏–Ω–µ—Ç –º–∞—Å—Ç–µ—Ä–∞ | TMA-ERP</title>
    <style>
        /* –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ —Å—Ç–∏–ª–∏ —á—Ç–æ –≤ applications.html */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .navbar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }
        
        .user-details h2 {
            margin: 0;
            font-size: 18px;
        }
        
        .user-details p {
            margin: 5px 0 0;
            color: #666;
            font-size: 14px;
        }
        
        .logout-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .content-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e8eaed;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #666;
        }
        
        .tab.active {
            border-bottom-color: #4CAF50;
            color: #4CAF50;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .form-control:focus {
            border-color: #4CAF50;
            outline: none;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #3d8b40;
            transform: translateY(-1px);
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        /* –¢–∞–±–ª–∏—Ü–∞ –∑–∞—è–≤–æ–∫ */
        .applications-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .applications-table th,
        .applications-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .applications-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-new { background: #e3f2fd; color: #1565c0; }
        .status-in_progress { background: #fff8e1; color: #ff8f00; }
        .status-accepted { background: #e8f5e9; color: #2e7d32; }
        .status-rejected { background: #ffebee; color: #c62828; }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–∞–ø–∫–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º -->
        <div class="navbar">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">–ò–ü</div>
                <div class="user-details">
                    <h2 id="user-name">–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤</h2>
                    <p id="user-role">üë∑ –ú–∞—Å—Ç–µ—Ä —É—á–∞—Å—Ç–∫–∞ | <span id="user-lot">–£—á–∞—Å—Ç–æ–∫ —Å–±–æ—Ä–∫–∏</span></p>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('new-application')">
                üìù –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞
            </div>
            <div class="tab" onclick="switchTab('my-applications')">
                üìã –ú–æ–∏ –∑–∞—è–≤–∫–∏
                <span id="apps-count-badge" class="badge" style="background: #ff4757; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 5px;">0</span>
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ "–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞" -->
        <div id="tab-new-application" class="tab-content active">
            <div class="content-card">
                <h2 style="margin-bottom: 25px;">üìù –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø—Ä–∏—ë–º–∫—É –û–¢–ö</h2>
                
                <div id="create-alert" class="alert" style="display: none;"></div>
                
                <form id="create-form">
                    <div class="form-group">
                        <label for="product-select">üì¶ –ò–∑–¥–µ–ª–∏–µ –¥–ª—è –ø—Ä–∏—ë–º–∫–∏ *</label>
                        <select id="product-select" class="form-control" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–¥–µ–ª–∏–µ...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="serial-number">üî¢ –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <input type="text" id="serial-number" class="form-control" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –∏–∑–¥–µ–ª–∏—è">
                        <small style="color: #666; font-size: 13px;">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ —Å–µ—Ä–∏–π–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –Ω–µ—Ç</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="drawing-number">üìê –ù–æ–º–µ—Ä —á–µ—Ä—Ç–µ–∂–∞</label>
                        <input type="text" id="drawing-number" class="form-control" 
                               placeholder="–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —á–µ—Ä—Ç–µ–∂–∞">
                    </div>
                    
                    <div class="form-group">
                        <label for="quantity">üî¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–¥–µ–ª–∏–π</label>
                        <input type="number" id="quantity" class="form-control" 
                               min="1" max="10" value="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                        <textarea id="notes" class="form-control" rows="3" 
                                  placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –û–¢–ö..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="desired-time">‚è∞ –ñ–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏—ë–º–∫–∏</label>
                        <input type="datetime-local" id="desired-time" class="form-control">
                    </div>
                    
                    <div class="form-group" style="margin-top: 30px;">
                        <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 18px;">
                            <span id="submit-text">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</span>
                            <span id="submit-loading" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> –°–æ–∑–¥–∞–Ω–∏–µ...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ "–ú–æ–∏ –∑–∞—è–≤–∫–∏" -->
        <div id="tab-my-applications" class="tab-content">
            <div class="content-card">
                <h2 style="margin-bottom: 25px;">üìã –ú–æ–∏ –∑–∞—è–≤–∫–∏</h2>
                
                <div id="apps-loading" class="loading">
                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...
                </div>
                
                <div id="apps-container" style="display: none;">
                    <table class="applications-table">
                        <thead>
                            <tr>
                                <th>–ù–æ–º–µ—Ä</th>
                                <th>–ò–∑–¥–µ–ª–∏–µ</th>
                                <th>–ß–µ—Ä—Ç–µ–∂</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="apps-table-body">
                            <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è JavaScript -->
                        </tbody>
                    </table>
                    
                    <div id="apps-empty" class="empty-state" style="display: none;">
                        üì≠ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ============
        let currentUser = null;
        let userProducts = [];
        let userApplications = [];
        
        // ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ============
        async function initializeMasterApp() {
            console.log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–±–∏–Ω–µ—Ç–∞ –º–∞—Å—Ç–µ—Ä–∞...');
            
            // 1. –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage
            const storedUser = localStorage.getItem('telegram_user');
            if (!storedUser) {
                console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å–∏–º—É–ª—è—Ç–æ—Ä');
                window.location.href = '/telegram-simulator.html';
                return;
            }
            
            try {
                currentUser = JSON.parse(storedUser);
                console.log('üë§ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', currentUser);
                
                if (currentUser.role !== 'master') {
                    alert('‚ùå –≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –º–∞—Å—Ç–µ—Ä–æ–≤!');
                    window.location.href = '/telegram-simulator.html';
                    return;
                }
                
                // 2. –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                updateUserUI();
                
                // 3. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–¥–µ–ª–∏—è —É—á–∞—Å—Ç–∫–∞ –º–∞—Å—Ç–µ—Ä–∞
                await loadUserProducts();
                
                // 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞—è–≤–∫–∏ –º–∞—Å—Ç–µ—Ä–∞
                await loadUserApplications();
                
                console.log('‚úÖ –ö–∞–±–∏–Ω–µ—Ç –º–∞—Å—Ç–µ—Ä–∞ –≥–æ—Ç–æ–≤!');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞.');
                logout();
            }
        }
        
        function updateUserUI() {
            // –ê–≤–∞—Ç–∞—Ä —Å –∏–Ω–∏—Ü–∏–∞–ª–∞–º–∏
            const initials = (currentUser.first_name[0] + 
                            (currentUser.last_name ? currentUser.last_name[0] : 
                             currentUser.first_name[1] || '')).toUpperCase();
            
            document.getElementById('user-avatar').textContent = initials;
            document.getElementById('user-name').textContent = 
                `${currentUser.first_name} ${currentUser.last_name || ''}`;
            document.getElementById('user-lot').textContent = currentUser.lot_name || '–£—á–∞—Å—Ç–æ–∫';
        }
        
        async function loadUserProducts() {
            console.log('üîç DEBUG loadUserProducts –≤—ã–∑–≤–∞–Ω–∞');
            console.log('üìä currentUser:', currentUser);
            
            try {
                console.log('üåê –ó–∞–ø—Ä–æ—Å –∫ /api/v1/products...');
                
                const response = await fetch('/api/v1/products');
                console.log('üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üì¶ –î–∞–Ω–Ω—ã–µ –æ—Ç API:', data);
                
                if (data.success) {
                    userProducts = data.products || [];
                    console.log('‚úÖ –ü—Ä–æ–¥—É–∫—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', userProducts.length);
                    
                    // –í—ã–≤–µ–¥–∏ –ø–µ—Ä–≤—ã–µ 3 –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                    if (userProducts.length > 0) {
                        console.log('üìù –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤:');
                        userProducts.slice(0, 3).forEach((p, i) => {
                            console.log(`  ${i+1}. ${p.name} (ID: ${p.id}, —Ç–∏–ø: ${p.type})`);
                        });
                    }
                    
                    populateProductSelect();
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ API:', data.error);
                    showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–¥–µ–ª–∏–π: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('üî• –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', error);
                showAlert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        function populateProductSelect() {
            const select = document.getElementById('product-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–¥–µ–ª–∏–µ...</option>';
            
            userProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} (${product.type_display || product.type})`;
                select.appendChild(option);
            });
        }
        
        async function loadUserApplications() {
            try {
                console.log('üìã –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫ –º–∞—Å—Ç–µ—Ä–∞:', currentUser.id);
                
                const response = await fetch(`/api/v1/applications?creator=${currentUser.id}`);
                const data = await response.json();
                
                if (data.success) {
                    userApplications = data.applications || [];
                    updateApplicationsUI();
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫:', error);
                // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            }
        }
        
        function updateApplicationsUI() {
            const countBadge = document.getElementById('apps-count-badge');
            const container = document.getElementById('apps-container');
            const loading = document.getElementById('apps-loading');
            const empty = document.getElementById('apps-empty');
            const tbody = document.getElementById('apps-table-body');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            if (countBadge) {
                countBadge.textContent = userApplications.length;
                countBadge.style.display = userApplications.length > 0 ? 'inline' : 'none';
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º loading
            if (loading) loading.style.display = 'none';
            
            if (userApplications.length === 0) {
                if (empty) empty.style.display = 'block';
                if (container) container.style.display = 'none';
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            if (container) container.style.display = 'block';
            if (empty) empty.style.display = 'none';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            if (tbody) {
                tbody.innerHTML = '';
                
                userApplications.forEach(app => {
                    const row = document.createElement('tr');
                    
                    const statusClass = `status-${app.status}`;
                    const statusText = getStatusText(app.status);
                    const createdAt = app.created_at ? 
                        new Date(app.created_at).toLocaleString('ru-RU') : '‚Äî';
                    
                    row.innerHTML = `
                        <td><strong>${app.application_number || '‚Äî'}</strong></td>
                        <td>${app.product_name || '‚Äî'}</td>
                        <td>${app.drawing_number || '‚Äî'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${createdAt}</td>
                        <td>
                            <button class="btn" style="padding: 5px 10px; font-size: 12px;" 
                                    onclick="viewApplication(${app.id})">
                                üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }
        }
        
        function getStatusText(status) {
            const statusMap = {
                'new': 'üÜï –ù–æ–≤–∞—è',
                'assigned_to_otk': 'üë§ –ù–∞–∑–Ω–∞—á–µ–Ω–∞',
                'in_progress': 'üîß –í —Ä–∞–±–æ—Ç–µ', 
                'accepted': '‚úÖ –ü—Ä–∏–Ω—è—Ç–∞',
                'rejected': '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∞',
                'in_resolution': 'üîÑ –í —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–∏'
            };
            return statusMap[status] || status;
        }
        
        // ============ –°–û–ó–î–ê–ù–ò–ï –ó–ê–Ø–í–ö–ò ============
        document.getElementById('create-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const submitBtn = event.submitter;
            const submitText = document.getElementById('submit-text');
            const submitLoading = document.getElementById('submit-loading');
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            submitBtn.disabled = true;
            submitText.style.display = 'none';
            submitLoading.style.display = 'inline';
            
            try {
                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                const productId = document.getElementById('product-select').value;
                const serialNumber = document.getElementById('serial-number').value.trim();
                const drawingNumber = document.getElementById('drawing-number').value.trim();
                const quantity = document.getElementById('quantity').value;
                const notes = document.getElementById('notes').value.trim();
                const desiredTime = document.getElementById('desired-time').value;
                
                if (!productId) {
                    throw new Error('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–¥–µ–ª–∏–µ!');
                }
                
                const requestData = {
                    lot_id: currentUser.lot_id,
                    product_id: productId,
                    creator_telegram_id: currentUser.id.toString(),
                    drawing_number: drawingNumber || null,
                    serial_numbers: serialNumber || null,
                    quantity: parseInt(quantity) || 1,
                    notes: notes || null,
                    desired_inspection_time: desiredTime || null,
                    send_telegram: 'true'
                };
                
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏:', requestData);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                const response = await fetch('/api/v1/applications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Fake-Telegram-User': JSON.stringify({
                            id: currentUser.id,
                            role: currentUser.role,
                            lot_id: currentUser.lot_id,
                            username: currentUser.username || ''
                        })
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                console.log('üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
                
                if (result.success) {
                    showAlert(`‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞! –ù–æ–º–µ—Ä: ${result.applications?.[0]?.application_number || '‚Äî'}`, 'success');
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    this.reset();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫
                    setTimeout(() => {
                        loadUserApplications();
                        switchTab('my-applications');
                    }, 1500);
                    
                } else {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏');
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏:', error);
                showAlert(`‚ùå ${error.message}`, 'error');
                
            } finally {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                submitBtn.disabled = false;
                submitText.style.display = 'inline';
                submitLoading.style.display = 'none';
            }
        });
        
        // ============ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ============
        function showAlert(message, type) {
            const alertDiv = document.getElementById('create-alert');
            if (!alertDiv) return;
            
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
            alertDiv.style.display = 'block';
            
            // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }
        
        function switchTab(tabName) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ "–ú–æ–∏ –∑–∞—è–≤–∫–∏" - –æ–±–Ω–æ–≤–ª—è–µ–º
            if (tabName === 'my-applications') {
                loadUserApplications();
            }
        }
        
        function viewApplication(appId) {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ –∏–ª–∏ –º–æ–¥–∞–ª–∫–µ
            window.open(`/applications.html?view=${appId}`, '_blank');
        }
        
        function logout() {
            localStorage.removeItem('telegram_user');
            window.location.href = '/telegram-simulator.html';
        }
        
        // ============ –ó–ê–ü–£–°–ö ============
        document.addEventListener('DOMContentLoaded', initializeMasterApp);
    </script>
</body>
</html>