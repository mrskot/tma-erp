<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞—è–≤–∫–∏ –û–¢–ö - TMA-ERP</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∑–∞—è–≤–æ–∫ */
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin: 2px;
        }
        
        .status-new { background: #e3f2fd; color: #1565c0; }
        .status-assigned_to_otk { background: #fff3e0; color: #ef6c00; }
        .status-in_progress { background: #fff8e1; color: #ff8f00; }
        .status-accepted { background: #e8f5e9; color: #2e7d32; }
        .status-rejected { background: #ffebee; color: #c62828; }
        .status-in_resolution { background: #f3e5f5; color: #6a1b9a; }
        .status-mixed_status { background: #e0f7fa; color: #006064; }
        .status-kr_pending { background: #e8eaf6; color: #3949ab; }
        .status-defect { background: #fce4ec; color: #880e4f; }
        
        .sync-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 5px;
        }
        
        .sync-success { background: #d4edda; color: #155724; }
        .sync-pending { background: #fff3cd; color: #856404; }
        .sync-failed { background: #f8d7da; color: #721c24; }
        
        .application-number {
            font-weight: bold;
            color: #1a73e8;
        }
        
        .bitrix-id {
            color: #34a853;
            font-weight: 600;
        }
        
        .telegram-message {
            color: #4285f4;
            cursor: pointer;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .btn-action {
            padding: 4px 10px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }
        
        .btn-action:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .btn-view { background: #1a73e8; color: white; }
        .btn-edit { background: #fbbc04; color: white; }
        .btn-assign { background: #4285f4; color: white; }
        .btn-start { background: #34a853; color: white; }
        .btn-accept { background: #0f9d58; color: white; }
        .btn-reject { background: #ea4335; color: white; }
        .btn-sync { background: #673ab7; color: white; }
        .btn-delete { background: #d93025; color: white; }
        
        .photo-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .has-photos { background: #34a853; }
        .no-photos { background: #dadce0; }
        
        .discrepancy-count {
            background: #f8f9fa;
            border: 1px solid #e8eaed;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 11px;
            margin-left: 5px;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e8eaed;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(90vh - 120px);
        }
        
        .modal-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e8eaed;
            text-align: right;
        }
        
        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e8eaed;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }
        
        .tab.active {
            border-bottom-color: #1a73e8;
            color: #1a73e8;
            background: #f0f7ff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞—è–≤–∫–∏ */
        .app-card {
            background: white;
            border: 1px solid #e8eaed;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        
        .app-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #d2e3fc;
        }
        
        .app-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .app-card-body {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .app-info-group h4 {
            margin: 0 0 8px 0;
            color: #5f6368;
            font-size: 13px;
            font-weight: 500;
        }
        
        .app-info-group p {
            margin: 0;
            font-size: 14px;
            color: #202124;
        }
        
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        .applications-table {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 16px;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .status-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .status-btn {
            padding: 4px 8px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 11px;
        }
        
        .btn-status-new { background: #e3f2fd; color: #1565c0; }
        .btn-status-assign { background: #fff3e0; color: #ef6c00; }
        .btn-status-start { background: #fff8e1; color: #ff8f00; }
        .btn-status-accept { background: #e8f5e9; color: #2e7d32; }
        .btn-status-reject { background: #ffebee; color: #c62828; }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .detail-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .detail-item h4 {
            margin: 0 0 5px 0;
            color: #5f6368;
            font-size: 12px;
        }
        
        .detail-item p {
            margin: 0;
            font-size: 14px;
            color: #202124;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .app-card-body {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn-action {
                width: 100%;
                justify-content: center;
            }
            
            .details-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–∞–ø–∫–∞ -->
        <nav class="navbar">
            <div class="nav-brand">
                <h1><i class="fas fa-clipboard-check"></i> –ó–∞—è–≤–∫–∏ –Ω–∞ –ø—Ä–∏—ë–º–∫—É –û–¢–ö</h1>
                <p>–°–æ–∑–¥–∞–Ω–∏–µ, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏ –∫–æ–Ω—Ç—Ä–æ–ª—è –∫–∞—á–µ—Å—Ç–≤–∞</p>
            </div>
            <div class="nav-links">
                <a href="/admin" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω–∫—É
                </a>
                <button onclick="showCreateModal()" class="btn btn-success">
                    <i class="fas fa-plus"></i> –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞
                </button>
                <button onclick="refreshData()" class="btn btn-info" title="–û–±–Ω–æ–≤–∏—Ç—å">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </nav>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
        <div class="content-card">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e3f2fd;">
                        <i class="fas fa-file-alt" style="color: #1565c0;"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="total-apps">0</h3>
                        <p>–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #fff3e0;">
                        <i class="fas fa-clock" style="color: #ef6c00;"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="pending-apps">0</h3>
                        <p>–í –æ–∂–∏–¥–∞–Ω–∏–∏</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e8f5e9;">
                        <i class="fas fa-check-circle" style="color: #2e7d32;"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="accepted-apps">0</h3>
                        <p>–ü—Ä–∏–Ω—è—Ç–æ</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #ffebee;">
                        <i class="fas fa-times-circle" style="color: #c62828;"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="rejected-apps">0</h3>
                        <p>–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</p>
                    </div>
                </div>
            </div>
            
            <div class="filters" style="margin-top: 20px;">
                <h3><i class="fas fa-filter"></i> –§–∏–ª—å—Ç—Ä—ã</h3>
                <div class="filter-row">
                    <div class="form-group">
                        <label for="filter-status">–°—Ç–∞—Ç—É—Å</label>
                        <select id="filter-status" class="form-control" onchange="filterApplications()">
                            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                            <option value="new">üÜï –ù–æ–≤–∞—è</option>
                            <option value="assigned_to_otk">üë§ –ù–∞–∑–Ω–∞—á–µ–Ω–∞ –û–¢–ö</option>
                            <option value="in_progress">üîß –í —Ä–∞–±–æ—Ç–µ</option>
                            <option value="accepted">‚úÖ –ü—Ä–∏–Ω—è—Ç–∞</option>
                            <option value="rejected">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∞</option>
                            <option value="in_resolution">üîÑ –í —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–∏</option>
                            <option value="mixed_status">‚ö° –°–º–µ—à–∞–Ω–Ω—ã–π</option>
                            <option value="kr_pending">üìã –ö–† –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏</option>
                            <option value="defect">üö´ –ë—Ä–∞–∫</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-lot">–£—á–∞—Å—Ç–æ–∫</label>
                        <select id="filter-lot" class="form-control" onchange="filterApplications()">
                            <option value="">–í—Å–µ —É—á–∞—Å—Ç–∫–∏</option>
                            <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-date">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</label>
                        <input type="date" id="filter-date" class="form-control" onchange="filterApplications()">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button onclick="resetFilters()" class="btn btn-secondary" style="margin-top: 8px;">
                            <i class="fas fa-redo"></i> –°–±—Ä–æ—Å–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('list')">
                <i class="fas fa-list"></i> –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫
            </div>
            <div class="tab" onclick="switchTab('sync')">
                <i class="fas fa-sync"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
                <span id="sync-badge" class="badge" style="background: #dc3545; margin-left: 5px;">0</span>
            </div>
            <div class="tab" onclick="switchTab('reports')">
                <i class="fas fa-chart-bar"></i> –û—Ç—á—ë—Ç—ã
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ -->
        <div id="tab-list" class="tab-content active">
            <div id="applications-list">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...
                </div>
            </div>
        </div>

        <!-- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è -->
        <div id="tab-sync" class="tab-content">
            <div class="content-card">
                <h3><i class="fas fa-sync-alt"></i> –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h3>
                <div id="sync-status">
                    <p><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...</p>
                </div>
                <div class="sync-controls" style="margin-top: 20px;">
                    <button onclick="processSyncQueue()" class="btn btn-primary">
                        <i class="fas fa-play"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
                    </button>
                    <button onclick="clearFailedSyncs()" class="btn btn-danger">
                        <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å –Ω–µ—É–¥–∞—á–Ω—ã–µ
                    </button>
                </div>
            </div>
        </div>

        <!-- –û—Ç—á—ë—Ç—ã -->
        <div id="tab-reports" class="tab-content">
            <div class="content-card">
                <h3><i class="fas fa-chart-bar"></i> –û—Ç—á—ë—Ç—ã –ø–æ –∑–∞—è–≤–∫–∞–º</h3>
                <p>–û—Ç—á—ë—Ç—ã –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...</p>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ -->
    <div id="create-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –ø—Ä–∏—ë–º–∫—É</h2>
                <button onclick="closeCreateModal()" class="btn btn-text">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="create-form" onsubmit="createApplication(event)" enctype="multipart/form-data">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="create-lot-id"><i class="fas fa-industry"></i> –£—á–∞—Å—Ç–æ–∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ *</label>
                            <select id="create-lot-id" class="form-control" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–æ–∫...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="create-product-id"><i class="fas fa-cube"></i> –ò–∑–¥–µ–ª–∏–µ *</label>
                            <select id="create-product-id" class="form-control" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–¥–µ–ª–∏–µ...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="create-drawing-number"><i class="fas fa-drafting-compass"></i> –ù–æ–º–µ—Ä —á–µ—Ä—Ç–µ–∂–∞</label>
                            <input type="text" id="create-drawing-number" class="form-control" 
                                  placeholder="–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —á–µ—Ä—Ç–µ–∂–∞">
                        </div>
                        <div class="form-group">
                            <label for="create-quantity"><i class="fas fa-hashtag"></i> –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–¥–µ–ª–∏–π</label>
                            <input type="number" id="create-quantity" class="form-control" 
                                  min="1" max="100" value="1"
                                  onchange="toggleSerialNumbers()">
                            <small class="text-muted">–°–∫–æ–ª—å–∫–æ –∏–∑–¥–µ–ª–∏–π –Ω–∞ –ø—Ä–∏—ë–º–∫—É?</small>
                        </div>
                    </div>
                    
                    <!-- –ë–õ–û–ö –°–ï–†–ò–ô–ù–´–• –ù–û–ú–ï–†–û–í -->
                    <div id="serial-numbers-section" class="form-group" style="display: none;">
                        <label for="create-serial-numbers"><i class="fas fa-list-ol"></i> –°–µ—Ä–∏–π–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <textarea id="create-serial-numbers" class="form-control" rows="3"
                                 placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–∑–¥–µ–ª–∏–π)&#10;–ü—Ä–∏–º–µ—Ä: SN-001, SN-002, SN-003"></textarea>
                        <small class="text-muted">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º - –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –∑–∞—è–≤–∫–∏ –±–µ–∑ —Å–µ—Ä–∏–π–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="create-notes"><i class="fas fa-sticky-note"></i> –ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                        <textarea id="create-notes" class="form-control" rows="2" 
                                 placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
                    </div>
                    
                    <!-- –ë–ª–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –ú–ö–ò -->
                    <div class="photo-upload-section" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4><i class="fas fa-camera"></i> –ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ / –ß–µ—Ä—Ç–µ–∂–∏ (–ú–ö–ò)</h4>
                        <div id="mki-photos-preview" class="photos-preview" style="margin: 10px 0; min-height: 50px; display: flex; flex-wrap: wrap; gap: 10px;">
                            <!-- –ü—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ -->
                        </div>
                        <div class="form-group">
                            <label for="mki-photo-input" class="btn btn-outline-primary" style="display: block; text-align: center; cursor: pointer;">
                                <i class="fas fa-cloud-upload-alt"></i> –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
                            </label>
                            <input type="file" id="mki-photo-input" multiple accept="image/*" style="display: none;"
                                  onchange="previewMkiPhotos(this)">
                            <small class="text-muted">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –º–∞—Ä—à—Ä—É—Ç–Ω–æ–π –∫–∞—Ä—Ç—ã –∏–ª–∏ —á–µ—Ä—Ç–µ–∂–∞ (JPG, PNG, –¥–æ 10MB, –º–∞–∫—Å. 5 —Ñ–∞–π–ª–æ–≤)</small>
                        </div>
                    </div>
                    
                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-group">
                            <label for="create-desired-time"><i class="fas fa-clock"></i> –ñ–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏—ë–º–∫–∏</label>
                            <input type="datetime-local" id="create-desired-time" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="create-otk-inspector"><i class="fas fa-user-check"></i> –ö–æ–Ω—Ç—Ä–æ–ª—ë—Ä –û–¢–ö</label>
                            <select id="create-otk-inspector" class="form-control">
                                <option value="">–ê–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ (–∏–∑ –∏–∑–¥–µ–ª–∏—è)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-check" style="margin: 15px 0;">
                        <input type="checkbox" id="create-send-telegram" class="form-check-input" checked>
                        <label for="create-send-telegram" class="form-check-label">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram-–∫–∞–Ω–∞–ª
                        </label>
                    </div>
                    
                    <!-- –ö–ù–û–ü–ö–ò -->
                    <div class="form-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                        <button type="button" onclick="closeCreateModal()" class="btn btn-secondary">
                            <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-paper-plane"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞—è–≤–∫–∏ -->
    <div id="view-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="view-title">–ó–∞—è–≤–∫–∞ #</h2>
                <button onclick="closeViewModal()" class="btn btn-text">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="view-content">
                    <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeViewModal()" class="btn btn-secondary">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
                <button onclick="editApplication()" class="btn btn-warning">
                    <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <button onclick="deleteApplication()" class="btn btn-danger">
                    <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                </button>
                <button onclick="syncApplication()" class="btn btn-primary">
                    <i class="fas fa-sync"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏</h2>
                <button onclick="closeEditModal()" class="btn btn-text">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="edit-form" onsubmit="updateApplication(event)">
                    <div id="edit-content">
                        <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è JavaScript -->
                    </div>
                    <div class="form-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                        <button type="button" onclick="closeEditModal()" class="btn btn-secondary">
                            <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞ -->
    <div id="status-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-exchange-alt"></i> –°–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏</h2>
                <button onclick="closeStatusModal()" class="btn btn-text">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-status">–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:</label>
                    <select id="new-status" class="form-control">
                        <option value="new">üÜï –ù–æ–≤–∞—è</option>
                        <option value="assigned_to_otk">üë§ –ù–∞–∑–Ω–∞—á–µ–Ω–∞ –û–¢–ö</option>
                        <option value="in_progress">üîß –í —Ä–∞–±–æ—Ç–µ</option>
                        <option value="accepted">‚úÖ –ü—Ä–∏–Ω—è—Ç–∞</option>
                        <option value="rejected">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∞</option>
                        <option value="in_resolution">üîÑ –í —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–∏</option>
                        <option value="kr_pending">üìã –ö–† –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏</option>
                        <option value="defect">üö´ –ë—Ä–∞–∫</option>
                    </select>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="status-notes">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                    <textarea id="status-notes" class="form-control" rows="3" placeholder="–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeStatusModal()" class="btn btn-secondary">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button onclick="confirmStatusChange()" class="btn btn-primary">
                    <i class="fas fa-check"></i> –°–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                </button>
            </div>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ -->
    <button onclick="forceDebug()" class="btn btn-warning" 
            style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
        <i class="fas fa-bug"></i> DEBUG
    </button>

    <!-- –°–ö–û–ü–ò–†–£–ô –í–ï–°–¨ –≠–¢–û–¢ –ë–õ–û–ö –°–ö–†–ò–ü–¢–û–í -->
    <script>
        // ============ –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ============
        window.applications = [];
        window.filteredApplications = [];
        window.lots = [];
        window.products = [];
        window.users = [];
        window.currentApplicationId = null;
        window.currentApplication = null;
        window.currentTab = 'list';
        window.pendingStatusChanges = {};
        
        // ============ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ============
        function showLoading() {
            const container = document.getElementById('applications-list');
            if (container) {
                container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            }
        }
        
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
        (function() {
            const adminUser = {
                id: 9999,
                first_name: 'Admin',
                username: 'admin_bot', 
                role: 'admin',
                auth_date: Math.floor(Date.now() / 1000),
                hash: 'admin_hash'
            };
            
            localStorage.setItem('telegram_user', JSON.stringify(adminUser));
            console.log('‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∫–∏');
        })();


        function showError(message) {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + message);
            console.error('TMA-ERP Error:', message);
        }
        
        function showSuccess(message) {
            alert('‚úÖ ' + message);
        }
        
        function getStatusText(status) {
            const statusMap = {
                'new': 'üÜï –ù–æ–≤–∞—è',
                'assigned_to_otk': 'üë§ –ù–∞–∑–Ω–∞—á–µ–Ω–∞ –û–¢–ö',
                'in_progress': 'üîß –í —Ä–∞–±–æ—Ç–µ',
                'accepted': '‚úÖ –ü—Ä–∏–Ω—è—Ç–∞',
                'rejected': '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∞',
                'in_resolution': 'üîÑ –í —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–∏',
                'mixed_status': '‚ö° –°–º–µ—à–∞–Ω–Ω—ã–π',
                'kr_pending': 'üìã –ö–† –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏',
                'defect': 'üö´ –ë—Ä–∞–∫'
            };
            return statusMap[status] || status;
        }
        
        // ============ –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ó–ê–ì–†–£–ó–ö–ò ============
        async function loadLots() {
            try {
                console.log('–ó–∞–ø—Ä–æ—Å –Ω–∞ /api/v1/lots...');
                const response = await fetch('/api/v1/lots');
                const data = await response.json();
                
                if (data.success) {
                    window.lots = data.lots || [];
                    console.log('–£—á–∞—Å—Ç–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ' + window.lots.length);
                    populateLotSelects();
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∞—Å—Ç–∫–æ–≤:', data.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∞—Å—Ç–∫–æ–≤:', error);
            }
        }
        
        async function loadProducts() {
            try {
                console.log('–ó–∞–ø—Ä–æ—Å –Ω–∞ /api/v1/products...');
                const response = await fetch('/api/v1/products');
                const data = await response.json();
                
                if (data.success) {
                    window.products = data.products || [];
                    console.log('–ò–∑–¥–µ–ª–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ' + window.products.length);
                    populateProductSelects();
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–¥–µ–ª–∏–π:', data.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–¥–µ–ª–∏–π:', error);
            }
        }
        
        async function loadUsers() {
            try {
                console.log('–ó–∞–ø—Ä–æ—Å –Ω–∞ /api/v1/users...');
                const response = await fetch('/api/v1/users');
                const data = await response.json();
                
                if (data.success) {
                    window.users = data.users || [];
                    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ' + window.users.length);
                    populateUserSelects();
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', data.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            }
        }
        
        async function loadApplications() {
            try {
                console.log('üîÑ –ó–∞–ø—Ä–æ—Å –Ω–∞ /api/v1/applications...');
                const response = await fetch('/api/v1/applications');
                
                console.log('üìä –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                
                const data = await response.json();
                console.log('üìä JSON –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, –∑–∞—è–≤–æ–∫:', data.applications?.length || 0);
                
                if (data.success) {
                    window.applications = data.applications || [];
                    window.filteredApplications = [...window.applications];
                    console.log('‚úÖ –ó–∞—è–≤–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ –ø–∞–º—è—Ç—å:', window.applications.length);
                    
                    updateStats();
                    renderApplicationsTable();
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data.error);
                    document.getElementById('applications-list').innerHTML = 
                        '<div class="error">–û—à–∏–±–∫–∞: ' + (data.error || 'Unknown error') + '</div>';
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫:', error);
                document.getElementById('applications-list').innerHTML = 
                    '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message + '</div>';
            }
        }
        
        // ============ –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ó–ê–Ø–í–û–ö ============
        function filterApplications() {
            const statusFilter = document.getElementById('filter-status').value;
            const lotFilter = document.getElementById('filter-lot').value;
            const dateFilter = document.getElementById('filter-date').value;
            
            console.log('–§–∏–ª—å—Ç—Ä—ã:', { statusFilter, lotFilter, dateFilter });
            
            let filtered = [...window.applications];
            
            // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
            if (statusFilter) {
                filtered = filtered.filter(app => app.status === statusFilter);
            }
            
            // –§–∏–ª—å—Ç—Ä –ø–æ —É—á–∞—Å—Ç–∫—É
            if (lotFilter) {
                filtered = filtered.filter(app => app.lot_id == lotFilter);
            }
            
            // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
            if (dateFilter) {
                const filterDate = new Date(dateFilter);
                filtered = filtered.filter(app => {
                    const appDate = new Date(app.created_at);
                    return appDate.toDateString() === filterDate.toDateString();
                });
            }
            
            window.filteredApplications = filtered;
            renderApplicationsTable();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ñ–∏–ª—å—Ç—Ä–æ–≤
            document.getElementById('total-apps').textContent = filtered.length;
        }
        
        function resetFilters() {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-lot').value = '';
            document.getElementById('filter-date').value = '';
            
            window.filteredApplications = [...window.applications];
            renderApplicationsTable();
            updateStats();
        }
        
        // ============ –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–ù–ù–´–• ============
        function updateStats() {
            const total = window.applications.length;
            const pending = window.applications.filter(a => a.status === 'new').length;
            const accepted = window.applications.filter(a => a.status === 'accepted').length;
            const rejected = window.applications.filter(a => a.status === 'rejected').length;
            
            const totalEl = document.getElementById('total-apps');
            const pendingEl = document.getElementById('pending-apps');
            const acceptedEl = document.getElementById('accepted-apps');
            const rejectedEl = document.getElementById('rejected-apps');
            
            if (totalEl) totalEl.textContent = total;
            if (pendingEl) pendingEl.textContent = pending;
            if (acceptedEl) acceptedEl.textContent = accepted;
            if (rejectedEl) rejectedEl.textContent = rejected;
        }
        
        function getStatusControl(app) {
            const statuses = [
                { value: 'new', text: 'üÜï –ù–æ–≤–∞—è' },
                { value: 'assigned_to_otk', text: 'üë§ –ù–∞–∑–Ω–∞—á–µ–Ω–∞ –û–¢–ö' },
                { value: 'in_progress', text: 'üîß –í —Ä–∞–±–æ—Ç–µ' },
                { value: 'accepted', text: '‚úÖ –ü—Ä–∏–Ω—è—Ç–∞' },
                { value: 'rejected', text: '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∞' },
                { value: 'in_resolution', text: 'üîÑ –í —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–∏' },
                { value: 'mixed_status', text: '‚ö° –°–º–µ—à–∞–Ω–Ω—ã–π' },
                { value: 'kr_pending', text: 'üìã –ö–† –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏' },
                { value: 'defect', text: 'üö´ –ë—Ä–∞–∫' }
            ];
            
            let options = '';
            statuses.forEach(status => {
                options += `<option value="${status.value}" ${app.status === status.value ? 'selected' : ''}>${status.text}</option>`;
            });
            
            return `
                <div class="status-control" style="display: flex; align-items: center;">
                    <select class="form-control status-select" style="font-size: 12px; padding: 4px 8px; height: 32px;" 
                            onchange="changeStatusFromSelect(${app.id}, this.value)">
                        ${options}
                    </select>
                    <button class="btn-status-apply" onclick="applyStatusChange(${app.id})" 
                            style="margin-left: 5px; padding: 4px 8px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        OK
                    </button>
                </div>
            `;
        }
        
        function renderApplicationsTable() {
            const container = document.getElementById('applications-list');
            if (!container) {
                console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä applications-list –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }
            
            const applications = window.filteredApplications;
            console.log('üîÑ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã –∑–∞—è–≤–æ–∫:', applications.length);
            
            if (applications.length === 0) {
                container.innerHTML = '<div class="empty-state">–ù–µ—Ç –∑–∞—è–≤–æ–∫</div>';
                return;
            }
            
            let html = '<div class="applications-table">';
            
            applications.forEach(app => {
                const statusClass = 'status-' + app.status;
                const statusText = getStatusText(app.status);
                
                html += '<div class="app-card">';
                html += '<div class="app-card-header">';
                html += '<div>';
                html += '<h3 class="application-number">' + (app.application_number || '–ë–µ–∑ –Ω–æ–º–µ—Ä–∞') + '</h3>';
                html += '<span class="status-badge ' + statusClass + '">' + statusText + '</span>';
                html += '</div>';
                html += '<div class="action-buttons">';
                html += '<button class="btn-action btn-view" onclick="viewApplication(' + app.id + ')">';
                html += '<i class="fas fa-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä';
                html += '</button>';
                html += '<button class="btn-action btn-edit" onclick="editApplication(' + app.id + ')">';
                html += '<i class="fas fa-edit"></i> –†–µ–¥.';
                html += '</button>';
                html += '<button class="btn-action btn-delete" onclick="deleteApplication(' + app.id + ', \'' + app.application_number + '\')">';
                html += '<i class="fas fa-trash"></i> –£–¥.';
                html += '</button>';
                html += '</div>';
                html += '</div>';
                html += '<div class="app-card-body">';
                html += '<div class="app-info-group">';
                html += '<h4>–£—á–∞—Å—Ç–æ–∫</h4>';
                html += '<p>' + (app.lot_name || '–ù–µ —É–∫–∞–∑–∞–Ω') + '</p>';
                html += '</div>';
                html += '<div class="app-info-group">';
                html += '<h4>–ò–∑–¥–µ–ª–∏–µ</h4>';
                html += '<p>' + (app.product_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ') + '</p>';
                html += '</div>';
                html += '<div class="app-info-group">';
                html += '<h4>–ß–µ—Ä—Ç–µ–∂</h4>';
                html += '<p>' + (app.drawing_number || '‚Äî') + '</p>';
                html += '</div>';
                html += '<div class="app-info-group">';
                html += '<h4>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</h4>';
                html += '<p>' + (app.product_serial_number || '‚Äî') + '</p>';
                html += '</div>';
                html += '<div class="app-info-group">';
                html += '<h4>–°—Ç–∞—Ç—É—Å</h4>';
                html += getStatusControl(app);
                html += '</div>';
                html += '<div class="app-info-group">';
                html += '<h4>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</h4>';
                html += '<p>' + (app.created_at ? new Date(app.created_at).toLocaleString() : '–ù–µ —É–∫–∞–∑–∞–Ω–∞') + '</p>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
            console.log('‚úÖ –¢–∞–±–ª–∏—Ü–∞ –∑–∞—è–≤–æ–∫ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω–∞!');
        }
        
        // ============ –°–ú–ï–ù–ê –°–¢–ê–¢–£–°–û–í ============
        function changeStatusFromSelect(appId, newStatus) {
            window.pendingStatusChanges[appId] = newStatus;
        }
        
        async function applyStatusChange(appId) {
            const newStatus = window.pendingStatusChanges[appId];
            if (!newStatus) {
                alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –∏–∑ —Å–ø–∏—Å–∫–∞');
                return;
            }
            
            const statusText = getStatusText(newStatus);
            const notes = prompt('–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):');
            
            if (confirm(`–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ #${appId} –Ω–∞ "${statusText}"?`)) {
                try {
                    const response = await fetch(`/api/v1/applications/${appId}/status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            status: newStatus, 
                            notes: notes || '' 
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showSuccess('–°—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!');
                        refreshData();
                    } else {
                        showError('–û—à–∏–±–∫–∞: ' + result.error);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞:', error);
                    showError('–û—à–∏–±–∫–∞: ' + error.message);
                }
            }
            
            delete window.pendingStatusChanges[appId];
        }
        
        // ============ –ü–†–û–°–ú–û–¢–† –ó–ê–Ø–í–ö–ò ============
        async function viewApplication(id) {
            try {
                console.log('–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–∫–∏ #' + id);
                const response = await fetch('/api/v1/applications/' + id);
                const data = await response.json();
                
                if (data.success) {
                    window.currentApplication = data.application;
                    window.currentApplicationId = id;
                    
                    const app = data.application;
                    const statusText = getStatusText(app.status);
                    
                    let html = '<div class="details-grid">';
                    html += '<div class="detail-item">';
                    html += '<h4>–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏</h4>';
                    html += '<p>' + (app.application_number || 'N/A') + '</p>';
                    html += '</div>';
                    
                    html += '<div class="detail-item">';
                    html += '<h4>–°—Ç–∞—Ç—É—Å</h4>';
                    html += '<p><span class="status-badge status-' + app.status + '">' + statusText + '</span></p>';
                    html += '</div>';
                    
                    html += '<div class="detail-item">';
                    html += '<h4>–£—á–∞—Å—Ç–æ–∫</h4>';
                    html += '<p>' + (app.lot_name || 'N/A') + '</p>';
                    html += '</div>';
                    
                    html += '<div class="detail-item">';
                    html += '<h4>–ò–∑–¥–µ–ª–∏–µ</h4>';
                    html += '<p>' + (app.product_name || 'N/A') + '</p>';
                    html += '</div>';
                    
                    html += '<div class="detail-item">';
                    html += '<h4>–ß–µ—Ä—Ç–µ–∂</h4>';
                    html += '<p>' + (app.drawing_number || '‚Äî') + '</p>';
                    html += '</div>';
                    
                    html += '<div class="detail-item">';
                    html += '<h4>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</h4>';
                    html += '<p>' + (app.product_serial_number || '‚Äî') + '</p>';
                    html += '</div>';
                    
                    html += '<div class="detail-item">';
                    html += '<h4>–°–æ–∑–¥–∞—Ç–µ–ª—å</h4>';
                    html += '<p>' + (app.creator_telegram_id || 'N/A') + '</p>';
                    html += '</div>';
                    
                    html += '<div class="detail-item">';
                    html += '<h4>–ö–æ–Ω—Ç—Ä–æ–ª—ë—Ä –û–¢–ö</h4>';
                    html += '<p>' + (app.otk_inspector_telegram_id || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω') + '</p>';
                    html += '</div>';
                    
                    html += '<div class="detail-item">';
                    html += '<h4>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</h4>';
                    html += '<p>' + (app.created_at ? new Date(app.created_at).toLocaleString() : 'N/A') + '</p>';
                    html += '</div>';
                    
                    html += '<div class="detail-item">';
                    html += '<h4>Bitrix24 ID</h4>';
                    html += '<p>' + (app.bitrix24_id || '–ù–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ') + '</p>';
                    html += '</div>';
                    html += '</div>';
                    
                    if (app.notes) {
                        html += '<div class="detail-item" style="grid-column: 1 / -1;">';
                        html += '<h4>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</h4>';
                        html += '<p style="white-space: pre-wrap;">' + app.notes + '</p>';
                        html += '</div>';
                    }
                    
                    // –§–æ—Ç–æ –ú–ö–ò
                    if (app.has_mki_photos) {
                        html += '<div class="detail-item" style="grid-column: 1 / -1;">';
                        html += '<h4><i class="fas fa-camera"></i> –§–æ—Ç–æ –ú–ö–ò</h4>';
                        html += '<div id="mki-photos-container" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">';
                        html += '<p><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...</p>';
                        html += '</div>';
                        html += '</div>';
                    }
                    
                    // –û–ø–∞—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
                    html += `
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; grid-column: 1 / -1;">
                            <h4 style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> –û–ø–∞—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h4>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button onclick="forceDeleteApplication(${app.id}, '${app.application_number}')" 
                                        class="btn btn-danger" style="flex: 1;">
                                    <i class="fas fa-trash-alt"></i> –ü–û–õ–ù–û–ï –£–î–ê–õ–ï–ù–ò–ï
                                </button>
                            </div>
                            <small class="text-muted">–£–¥–∞–ª–∏—Ç –∏–∑ –ë–î, Telegram –∏ Bitrix24. –ù–µ–æ–±—Ä–∞—Ç–∏–º–æ!</small>
                        </div>
                    `;
                    
                    document.getElementById('view-title').textContent = '–ó–∞—è–≤–∫–∞ #' + (app.application_number || app.id);
                    document.getElementById('view-content').innerHTML = html;
                    showViewModal();
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                    if (app.has_mki_photos) {
                        setTimeout(() => loadApplicationPhotos(app.id), 100);
                    }
                } else {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + data.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞—è–≤–∫–∏:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
            }
        }
        
        // ============ –ó–ê–ì–†–£–ó–ö–ê –§–û–¢–û –ó–ê–Ø–í–ö–ò ============
        async function loadApplicationPhotos(appId) {
            try {
                const response = await fetch(`/api/v1/applications/${appId}/photos`);
                const data = await response.json();
                
                if (data.success && data.photos.length > 0) {
                    const container = document.getElementById('mki-photos-container');
                    container.innerHTML = '';
                    
                    data.photos.forEach(photo => {
                        const wrapper = document.createElement('div');
                        wrapper.style.position = 'relative';
                        wrapper.style.cursor = 'pointer';
                        wrapper.style.border = '2px solid #ddd';
                        wrapper.style.borderRadius = '8px';
                        wrapper.style.overflow = 'hidden';
                        wrapper.style.width = '150px';
                        wrapper.style.height = '150px';
                        wrapper.onclick = () => window.open(photo.url, '_blank');
                        
                        const img = document.createElement('img');
                        img.src = photo.thumbnail_url || photo.url;
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'cover';
                        img.title = photo.type === 'mki' ? '–ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞' : '–§–æ—Ç–æ';
                        
                        wrapper.appendChild(img);
                        container.appendChild(wrapper);
                    });
                } else {
                    const container = document.getElementById('mki-photos-container');
                    container.innerHTML = '<p>–§–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ:', error);
                const container = document.getElementById('mki-photos-container');
                container.innerHTML = '<p style="color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</p>';
            }
        }
        
        // ============ –ü–û–õ–ù–û–ï –£–î–ê–õ–ï–ù–ò–ï –ó–ê–Ø–í–ö–ò ============
        async function forceDeleteApplication(id, appNumber) {
            if (!confirm(`üö® –í–ù–ò–ú–ê–ù–ò–ï!\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É #${appNumber}?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ:\n‚Ä¢ –£–¥–∞–ª–∏—Ç –∑–∞—è–≤–∫—É –∏–∑ –ë–î\n‚Ä¢ –£–¥–∞–ª–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ Telegram –∫–∞–Ω–∞–ª–∞\n‚Ä¢ –£–¥–∞–ª–∏—Ç –∑–∞—è–≤–∫—É –∏–∑ Bitrix24\n‚Ä¢ –£–¥–∞–ª–∏—Ç –≤—Å–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã\n\n–î–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û!`)) {
                return;
            }
            
            const confirmText = prompt('–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ "–£–î–ê–õ–ò–¢–¨" (–±–µ–∑ –∫–∞–≤—ã—á–µ–∫):');
            if (confirmText !== '–£–î–ê–õ–ò–¢–¨') {
                alert('‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/applications/${id}?force=true`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('–ó–∞—è–≤–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω–∞!');
                    closeViewModal();
                    refreshData();
                } else {
                    showError('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                showError('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // ============ –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–Ø–í–ö–ò ============
        async function editApplication(id) {
            if (!id && window.currentApplicationId) {
                id = window.currentApplicationId;
            }
            
            if (!id) {
                showError('–ù–µ –≤—ã–±—Ä–∞–Ω–∞ –∑–∞—è–≤–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }
            
            try {
                console.log('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ #' + id);
                const response = await fetch('/api/v1/applications/' + id);
                const data = await response.json();
                
                if (data.success) {
                    window.currentApplicationId = id;
                    const app = data.application;
                    
                    let html = '<div class="form-row">';
                    html += '<div class="form-group">';
                    html += '<label for="edit-notes">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>';
                    html += '<textarea id="edit-notes" class="form-control" rows="4">' + (app.notes || '') + '</textarea>';
                    html += '</div>';
                    html += '</div>';
                    
                    html += '<div class="form-row">';
                    html += '<div class="form-group">';
                    html += '<label for="edit-otk-inspector">–ö–æ–Ω—Ç—Ä–æ–ª—ë—Ä –û–¢–ö</label>';
                    html += '<select id="edit-otk-inspector" class="form-control">';
                    html += '<option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</option>';
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç—Ä–æ–ª—ë—Ä–æ–≤
                    const otkUsers = window.users.filter(user => 
                        user.role === 'otk_inspector' || 
                        user.role === 'admin' || 
                        user.role === 'super_admin'
                    );
                    
                    otkUsers.forEach(user => {
                        const displayName = (user.first_name || '') + ' ' + (user.last_name || '');
                        const selected = user.telegram_id === app.otk_inspector_telegram_id ? 'selected' : '';
                        html += '<option value="' + user.telegram_id + '" ' + selected + '>' + 
                               (displayName.trim() || user.username || user.telegram_id) + '</option>';
                    });
                    
                    html += '</select>';
                    html += '</div>';
                    html += '<div class="form-group">';
                    html += '<label for="edit-desired-time">–ñ–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏—ë–º–∫–∏</label>';
                    html += '<input type="datetime-local" id="edit-desired-time" class="form-control" value="' + 
                           (app.desired_inspection_time ? app.desired_inspection_time.substring(0, 16) : '') + '">';
                    html += '</div>';
                    html += '</div>';
                    
                    // –ß–µ—Ä—Ç–µ–∂ –∏ —Å–µ—Ä–∏–π–Ω–∏–∫
                    html += '<div class="form-row">';
                    html += '<div class="form-group">';
                    html += '<label for="edit-drawing-number">–ù–æ–º–µ—Ä —á–µ—Ä—Ç–µ–∂–∞</label>';
                    html += '<input type="text" id="edit-drawing-number" class="form-control" value="' + (app.drawing_number || '') + '">';
                    html += '</div>';
                    html += '<div class="form-group">';
                    html += '<label for="edit-serial-number">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</label>';
                    html += '<input type="text" id="edit-serial-number" class="form-control" value="' + (app.product_serial_number || '') + '">';
                    html += '</div>';
                    html += '</div>';
                    
                    document.getElementById('edit-content').innerHTML = html;
                    showEditModal();
                } else {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + data.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–∫–∏:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
            }
        }
        
        async function updateApplication(event) {
            event.preventDefault();
            
            if (!window.currentApplicationId) {
                showError('–ù–µ –≤—ã–±—Ä–∞–Ω–∞ –∑–∞—è–≤–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }
            
            try {
                const updates = {
                    notes: document.getElementById('edit-notes').value,
                    otk_inspector_telegram_id: document.getElementById('edit-otk-inspector').value || null,
                    desired_inspection_time: document.getElementById('edit-desired-time').value || null,
                    drawing_number: document.getElementById('edit-drawing-number').value || null,
                    product_serial_number: document.getElementById('edit-serial-number').value || null
                };
                
                console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ #' + window.currentApplicationId, updates);
                
                const response = await fetch('/api/v1/applications/' + window.currentApplicationId, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updates)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
                    closeEditModal();
                    refreshData();
                    closeViewModal();
                } else {
                    showError('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + data.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:', error);
                showError('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + error.message);
            }
        }
        
        // ============ –£–î–ê–õ–ï–ù–ò–ï –ó–ê–Ø–í–ö–ò (–º—è–≥–∫–æ–µ) ============
        async function deleteApplication(id, appNumber) {
            if (!id && window.currentApplicationId) {
                id = window.currentApplicationId;
                appNumber = window.currentApplication?.application_number;
            }
            
            if (!id) {
                showError('–ù–µ –≤—ã–±—Ä–∞–Ω–∞ –∑–∞—è–≤–∫–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }
            
            const confirmMsg = appNumber ? 
                '–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É #' + appNumber + '?' : 
                '–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É #' + id + '?';
            
            if (!confirm(confirmMsg + '\n\n–í–Ω–∏–º–∞–Ω–∏–µ: –ó–∞—è–≤–∫–∞ –±—É–¥–µ—Ç –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ (–º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ).\n\n–î–ª—è –ø–æ–ª–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–ø—Ü–∏—é –≤ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ –∑–∞—è–≤–∫–∏.')) {
                return;
            }
            
            try {
                console.log('–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ #' + id);
                
                const response = await fetch('/api/v1/applications/' + id, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!');
                    closeViewModal();
                    refreshData();
                } else {
                    showError('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + data.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:', error);
                showError('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message);
            }
        }
        
        // ============ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ============
        function populateLotSelects() {
            const filterSelect = document.getElementById('filter-lot');
            const createSelect = document.getElementById('create-lot-id');
            
            if (!filterSelect || !createSelect) return;
            
            [filterSelect, createSelect].forEach(select => {
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–æ–∫...</option>';
                
                window.lots.forEach(lot => {
                    const option = document.createElement('option');
                    option.value = lot.id;
                    option.textContent = lot.name + (lot.code ? ' (' + lot.code + ')' : '');
                    select.appendChild(option);
                });
            });
        }
        
        function populateProductSelects() {
            const createSelect = document.getElementById('create-product-id');
            if (!createSelect) return;
            
            createSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–¥–µ–ª–∏–µ...</option>';
            
            window.products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.name + (product.type_display ? ' (' + product.type_display + ')' : '');
                createSelect.appendChild(option);
            });
        }
        
        function populateUserSelects() {
            const otkSelect = document.getElementById('create-otk-inspector');
            if (!otkSelect) return;
            
            otkSelect.innerHTML = '<option value="">–ê–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ</option>';
            
            const otkUsers = window.users.filter(user => 
                user.role === 'otk_inspector' || 
                user.role === 'admin' || 
                user.role === 'super_admin'
            );
            
            otkUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.telegram_id;
                const displayName = (user.first_name || '') + ' ' + (user.last_name || '');
                option.textContent = displayName.trim() || user.username || user.telegram_id;
                otkSelect.appendChild(option);
            });
        }
        
        function toggleSerialNumbers() {
            const quantity = parseInt(document.getElementById('create-quantity').value) || 1;
            const serialSection = document.getElementById('serial-numbers-section');
            
            if (serialSection) {
                if (quantity > 1) {
                    serialSection.style.display = 'block';
                } else {
                    serialSection.style.display = 'none';
                    document.getElementById('create-serial-numbers').value = '';
                }
            }
        }
        
        function previewMkiPhotos(input) {
            const preview = document.getElementById('mki-photos-preview');
            if (!preview) return;
            
            preview.innerHTML = '';
            
            if (input.files && input.files.length > 0) {
                for (let i = 0; i < input.files.length; i++) {
                    const file = input.files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.width = '100px';
                        img.style.height = '100px';
                        img.style.objectFit = 'cover';
                        img.style.margin = '5px';
                        img.style.borderRadius = '5px';
                        img.style.border = '2px solid #ddd';
                        
                        preview.appendChild(img);
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
        }
        
        // ============ –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ============
        function showCreateModal() {
            const modal = document.getElementById('create-modal');
            if (modal) modal.style.display = 'flex';
        }
        
        function closeCreateModal() {
            const modal = document.getElementById('create-modal');
            if (modal) modal.style.display = 'none';
            const form = document.getElementById('create-form');
            if (form) form.reset();
            toggleSerialNumbers();
        }
        
        function showViewModal() {
            const modal = document.getElementById('view-modal');
            if (modal) modal.style.display = 'flex';
        }
        
        function closeViewModal() {
            const modal = document.getElementById('view-modal');
            if (modal) modal.style.display = 'none';
            window.currentApplicationId = null;
            window.currentApplication = null;
        }
        
        function showEditModal() {
            const modal = document.getElementById('edit-modal');
            if (modal) modal.style.display = 'flex';
        }
        
        function closeEditModal() {
            const modal = document.getElementById('edit-modal');
            if (modal) modal.style.display = 'none';
        }
        
        // ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ============
        async function initializePage() {
            console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã...');
            console.log('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä:', document.getElementById('applications-list'));
            
            showLoading();
            
            try {
                console.log('üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                console.log('1. –ó–∞–≥—Ä—É–∂–∞–µ–º —É—á–∞—Å—Ç–∫–∏...');
                await loadLots();
                
                console.log('2. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–¥–µ–ª–∏—è...');
                await loadProducts();
                
                console.log('3. –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
                await loadUsers();
                
                console.log('4. –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞—è–≤–∫–∏...');
                await loadApplications();
                
                console.log('‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
                console.log('–ó–∞—è–≤–æ–∫ –≤ –ø–∞–º—è—Ç–∏:', window.applications.length);
                console.log('–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö:', window.filteredApplications.length);
                
                toggleSerialNumbers();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                document.getElementById('applications-list').innerHTML = 
                    '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message + '</div>';
            }
        }
        
        function refreshData() {
            console.log('üîÑ –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');
            initializePage();
        }
        
        // ============ –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ë–´–¢–ò–ô ============
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é...');
            initializePage();
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(() => {
                if (window.currentTab === 'list') {
                    console.log('üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫...');
                    loadApplications();
                }
            }, 30000);
        });

          async function createApplication(event) {
        event.preventDefault();
        
        console.log('üõ†Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏...');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const submitBtn = event.submitter || event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –°–æ–∑–¥–∞–Ω–∏–µ...';
        submitBtn.disabled = true;
        
        try {
            // 1. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const lotId = document.getElementById('create-lot-id').value;
            const productId = document.getElementById('create-product-id').value;
            
            if (!lotId || !productId) {
                alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–æ–∫ –∏ –∏–∑–¥–µ–ª–∏–µ!');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                return;
            }
            
            const formData = new FormData();
            
            // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            formData.append('lot_id', lotId);
            formData.append('product_id', productId);
            formData.append('creator_telegram_id', 'admin_bot'); // –≤—Ä–µ–º–µ–Ω–Ω–æ
            
            // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
            const drawingNumber = document.getElementById('create-drawing-number').value;
            const serialNumbers = document.getElementById('create-serial-numbers').value;
            const quantity = document.getElementById('create-quantity').value;
            const notes = document.getElementById('create-notes').value;
            const desiredTime = document.getElementById('create-desired-time').value;
            const otkInspector = document.getElementById('create-otk-inspector').value;
            const sendTelegram = document.getElementById('create-send-telegram').checked;
            
            if (drawingNumber) formData.append('drawing_number', drawingNumber);
            if (serialNumbers) formData.append('serial_numbers', serialNumbers);
            formData.append('quantity', quantity || '1');
            if (notes) formData.append('notes', notes);
            if (desiredTime) formData.append('desired_inspection_time', desiredTime);
            if (otkInspector) formData.append('otk_inspector_telegram_id', otkInspector);
            formData.append('send_telegram', sendTelegram.toString());
            
            // 2. –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã
            const photoInput = document.getElementById('mki-photo-input');
            if (photoInput.files.length > 0) {
                console.log(`üì∏ –ó–∞–≥—Ä—É–∂–∞–µ–º ${photoInput.files.length} —Ñ–æ—Ç–æ`);
                for (let i = 0; i < photoInput.files.length; i++) {
                    formData.append('mki_photos', photoInput.files[i]);
                }
            }
            
            // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
            
            const response = await fetch('/api/v1/applications', {
                method: 'POST',
                body: formData
            });
            
            console.log('üì• –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω:', response.status);
            
            const result = await response.json();
            console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç:', result);
            
            if (result.success) {
                showSuccess(`‚úÖ –£—Å–ø–µ—à–Ω–æ! –°–æ–∑–¥–∞–Ω–æ ${result.created_count || 1} –∑–∞—è–≤–æ–∫`);
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('create-form').reset();
                document.getElementById('mki-photos-preview').innerHTML = '';
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
                setTimeout(() => {
                    closeCreateModal();
                    refreshData();
                }, 1500);
                
            } else {
                showError('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
            
        } catch (error) {
            console.error('üî• –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏:', error);
            showError('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
            
        } finally {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    </script>
</body>
</html>